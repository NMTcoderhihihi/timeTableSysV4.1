<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>B·∫£ng ƒêi·ªÅu Khi·ªÉn</title>
    <script
      type="text/javascript"
      src="https://www.gstatic.com/charts/loader.js"
    ></script>
    <style>
      :root {
        --primary-color: #4285f4;
        --background-color: #f5f5f5;
        --card-background: #ffffff;
        --text-color: #212121;
        --text-light: #757575;
        --border-color: #e0e0e0;
        --success-color: #0f9d58;
        --danger-color: #db4437;
      }
      body {
        margin: 0;
        padding: 15px 15px 80px 15px;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background-color: var(--background-color);
        color: var(--text-color);
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
      .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 60px;
        background-color: var(--card-background);
        display: flex;
        justify-content: space-around;
        align-items: center;
        box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
      }
      .nav-button {
        background: none;
        border: none;
        color: var(--text-light);
        display: flex;
        flex-direction: column;
        align-items: center;
        font-size: 12px;
        cursor: pointer;
        padding: 5px 10px;
        transition: color 0.2s;
      }
      .nav-button.active {
        color: var(--primary-color);
      }
      .nav-button .icon {
        font-size: 24px;
      }
      .card {
        background-color: var(--card-background);
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 15px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
      }
      .card-title {
        font-size: 18px;
        font-weight: 500;
        margin: 0 0 12px 0;
      }
      .btn {
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        color: white;
        margin-top: 10px;
        transition: background-color 0.2s, opacity 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }
      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .btn-primary {
        background-color: var(--primary-color);
      }
      .btn-success {
        background-color: var(--success-color);
      }
      .btn-danger {
        background-color: var(--danger-color);
      }
      .btn-secondary {
        background-color: #6c757d;
        color: white;
      }
      .status-grid {
        display: grid;
        grid-template-columns: auto 1fr;
        gap: 8px 16px;
        align-items: center;
      }
      .status-label {
        color: var(--text-light);
      }
      .status-value {
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
      }
      .dot-green {
        background-color: var(--success-color);
      }
      .dot-red {
        background-color: var(--danger-color);
      }
      .form-group {
        margin-bottom: 15px;
      }
      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
      }
      .form-group input {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        box-sizing: border-box;
        font-size: 16px;
      }
      .form-group input[readonly] {
        background-color: #f0f0f0;
        cursor: not-allowed;
      }
      .toast {
        position: fixed;
        bottom: 80px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 12px 24px;
        border-radius: 25px;
        z-index: 2000;
        opacity: 0;
        transition: opacity 0.3s, transform 0.3s;
        pointer-events: none;
      }
      .toast.show {
        opacity: 1;
        transform: translateX(-50%) translateY(-10px);
      }
      .loader-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.7);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }
      .loader {
        border: 5px solid #f3f3f3;
        border-top: 5px solid var(--primary-color);
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .accordion-header {
        padding: 16px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 16px;
        font-weight: 500;
      }
      .accordion-header::after {
        content: "‚ñº";
        font-size: 14px;
        transition: transform 0.2s;
      }
      .accordion-header.active::after {
        transform: rotate(180deg);
      }
      .accordion-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.2s ease-out;
        padding: 0 16px;
        border-top: 1px solid var(--border-color);
      }
      .accordion-content.show {
        padding-bottom: 16px;
      }
    </style>
  </head>
  <body>
    <div class="main-content">
      <div id="controls-content" class="tab-content active">
        <div class="card">
          <h2 class="card-title">Tr·∫°ng th√°i H·ªá th·ªëng</h2>
          <div class="status-grid">
            <div class="status-label">C·∫•u h√¨nh</div>
            <div id="status-configured" class="status-value"></div>
            <div class="status-label">Kh·ªüi t·∫°o</div>
            <div id="status-initialized" class="status-value"></div>
            <div class="status-label">ƒê·ªìng b·ªô T·ª± ƒë·ªông</div>
            <div id="status-autosync" class="status-value"></div>
          </div>
        </div>
        <div class="card">
          <h2 class="card-title">H√†nh ƒë·ªông</h2>
          <button id="btn-main-action" class="btn btn-primary">
            üöÄ B·∫Øt ƒë·∫ßu Kh·ªüi t·∫°o
          </button>
          <button id="btn-manual-sync" class="btn btn-success">
            üîÑ C·∫≠p nh·∫≠t Nhanh
          </button>
          <button id="btn-toggle-autosync" class="btn btn-secondary">
            ‚ö° K√≠ch ho·∫°t ƒê·ªìng b·ªô T·ª± ƒë·ªông
          </button>
        </div>
      </div>
      <div id="dashboard-content" class="tab-content">
        <div class="card">
          <h2 class="card-title">B√°o c√°o Chuy√™n c·∫ßn</h2>
          <div id="chart-container"><p>ƒêang t·∫£i d·ªØ li·ªáu...</p></div>
        </div>
      </div>

      <div id="settings-content" class="tab-content">
        <div class="card">
          <div class="accordion-header active">C√†i ƒë·∫∑t chung</div>
          <div class="accordion-content show" style="max-height: 500px">
            <div class="form-group">
              <label for="studentId">M√£ s·ªë sinh vi√™n (*)</label
              ><input type="text" id="studentId" />
            </div>
            <div class="form-group">
              <label for="email">Email (*)</label
              ><input type="email" id="email" />
            </div>
            <div class="form-group">
              <label>Spreadsheet ID (t·ª± ƒë·ªông t·∫°o)</label
              ><input type="text" id="spreadsheetId" readonly />
            </div>
            <div class="form-group">
              <label>Calendar ID (t·ª± ƒë·ªông t·∫°o/nh·∫≠p)</label
              ><input type="text" id="calendarId" />
            </div>
          </div>
        </div>
        <div class="card">
          <div class="accordion-header">C√†i ƒë·∫∑t n√¢ng cao</div>
          <div class="accordion-content">
            <div class="form-group">
              <label>S·ªë bu·ªïi h·ªçc/l·∫ßn t·∫£i API</label
              ><input type="number" id="pageSize" placeholder="100" />
            </div>
            <div class="form-group">
              <label>S·ªë l·∫ßn th·ª≠ l·∫°i t·ªëi ƒëa (API l·ªói)</label
              ><input type="number" id="maxRetries" placeholder="3" />
            </div>
            <div class="form-group">
              <label>ƒê·ªô tr·ªÖ gi·ªØa c√°c l·∫ßn th·ª≠ l·∫°i (gi√¢y)</label
              ><input type="number" id="retryDelaySeconds" placeholder="10" />
            </div>
            <div class="form-group">
  <label>Gemini API Key</label>
  <input type="password" id="geminiApiKey" placeholder="Nh·∫≠p API Key c·ªßa b·∫°n t·∫°i ƒë√¢y" />
</div>
          </div>
        </div>
        <div class="card">
          <div class="accordion-header">Th·ªùi ƒëi·ªÉm ƒê·ªìng b·ªô T·ª± ƒë·ªông</div>
          <div class="accordion-content">
            <p style="color: var(--text-light); font-size: 14px">
              ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng d√πng. Th·ªùi gian s·∫Ω ƒë∆∞·ª£c t·ª± ƒë·ªông l√†m tr√≤n (VD:
              07:08 -> 07:00).
            </p>
            <div class="form-group">
              <label>Th·ªùi ƒëi·ªÉm 1 (HH:mm)</label
              ><input type="time" id="syncTime1" />
            </div>
            <div class="form-group">
              <label>Th·ªùi ƒëi·ªÉm 2 (HH:mm)</label
              ><input type="time" id="syncTime2" />
            </div>
            <div class="form-group">
              <label>Th·ªùi ƒëi·ªÉm 3 (HH:mm)</label
              ><input type="time" id="syncTime3" />
            </div>
          </div>
        </div>
        <button id="btn-save-settings" class="btn btn-primary">
          üíæ L∆∞u Thay ƒë·ªïi
        </button>
      </div>
    </div>

    <nav class="bottom-nav">
      <button class="nav-button active" onclick="switchTab('controls')">
        <span class="icon">üïπÔ∏è</span>B·∫£ng ƒëi·ªÅu khi·ªÉn
      </button>
      <button class="nav-button" onclick="switchTab('dashboard')">
        <span class="icon">üìä</span>B√°o c√°o
      </button>
      <button class="nav-button" onclick="switchTab('settings')">
        <span class="icon">‚öôÔ∏è</span>C√†i ƒë·∫∑t
      </button>
    </nav>
    <div id="toast" class="toast"></div>
    <div id="loader-overlay" class="loader-overlay">
      <div class="loader"></div>
    </div>

    <script>
      google.charts.load("current", { packages: ["corechart"] });
      google.charts.setOnLoadCallback(drawChart); // ƒêƒÉng k√Ω h√†m v·∫Ω sau khi th∆∞ vi·ªán t·∫£i xong

      // --- DOM Elements ---
      const dom = {
        loader: document.getElementById("loader-overlay"),
        toast: document.getElementById("toast"),
        navButtons: document.querySelectorAll(".nav-button"),
        tabContents: document.querySelectorAll(".tab-content"),
        status: {
          configured: document.getElementById("status-configured"),
          initialized: document.getElementById("status-initialized"),
          autosync: document.getElementById("status-autosync"),
        },
        buttons: {
          mainAction: document.getElementById("btn-main-action"),
          toggleAutosync: document.getElementById("btn-toggle-autosync"),
          manualSync: document.getElementById("btn-manual-sync"),
          saveSettings: document.getElementById("btn-save-settings"),
        },
        chartContainer: document.getElementById("chart-container"),
        inputs: {
          studentId: document.getElementById("studentId"),
          email: document.getElementById("email"),
          spreadsheetId: document.getElementById("spreadsheetId"),
          calendarId: document.getElementById("calendarId"),
          pageSize: document.getElementById("pageSize"),
          maxRetries: document.getElementById("maxRetries"),
          retryDelaySeconds: document.getElementById("retryDelaySeconds"),
          syncTime1: document.getElementById("syncTime1"),
          syncTime2: document.getElementById("syncTime2"),
          syncTime3: document.getElementById("syncTime3"),
            geminiApiKey: document.getElementById("geminiApiKey"),
        },
      };
      let toastTimeout;
      let chartLoaded = false; // Bi·∫øn c·ªù ƒë·ªÉ ch·ªâ v·∫Ω bi·ªÉu ƒë·ªì m·ªôt l·∫ßn

      // --- UI Logic ---
      function setLoading(isLoading) {
        dom.loader.style.display = isLoading ? "flex" : "none";
      }

      function showToast(message, isError = false) {
        dom.toast.textContent = message;
        dom.toast.style.backgroundColor = isError
          ? "var(--danger-color)"
          : "rgba(0,0,0,0.8)";
        dom.toast.classList.add("show");
        clearTimeout(toastTimeout);
        toastTimeout = setTimeout(
          () => dom.toast.classList.remove("show"),
          3000,
        );
      }

      function switchTab(tabName) {
        dom.tabContents.forEach((c) => c.classList.remove("active"));
        dom.navButtons.forEach((b) => b.classList.remove("active"));
        document.getElementById(tabName + "-content").classList.add("active");
        document
          .querySelector(`.nav-button[onclick="switchTab('${tabName}')"]`)
          .classList.add("active");
        if (tabName === "dashboard" && !chartLoaded) {
          // Ch·ªâ t·∫£i l·∫°i chart n·∫øu ch∆∞a t·ª´ng t·∫£i
          drawChart();
        }
      }
      function drawChart() {
        dom.chartContainer.innerHTML = "<p>ƒêang t·∫£i d·ªØ li·ªáu...</p>";
        google.script.run
          .withSuccessHandler((response) => {
            if (response.error) {
              dom.chartContainer.innerHTML = `<p>${response.error}</p>`;
              return;
            }
            if (response.chartData.length <= 1) {
              dom.chartContainer.innerHTML = `<p>Kh√¥ng c√≥ d·ªØ li·ªáu chuy√™n c·∫ßn ƒë·ªÉ hi·ªÉn th·ªã.</p>`;
              return;
            }

            const data = google.visualization.arrayToDataTable(
              response.chartData,
            );
            const options = {
              title: "T·ª∑ l·ªá chuy√™n c·∫ßn theo m√¥n h·ªçc",
              pieHole: 0.4,
              legend: { position: "bottom" },
            };
            const chart = new google.visualization.PieChart(dom.chartContainer);
            chart.draw(data, options);
            chartLoaded = true; // ƒê√°nh d·∫•u ƒë√£ t·∫£i chart
          })
          .withFailureHandler((err) => {
            dom.chartContainer.innerHTML = `<p>L·ªói khi v·∫Ω bi·ªÉu ƒë·ªì: ${err.message}</p>`;
          })
          .controllers_Main_getDashboardData();
      }

      function renderStatus(value, textTrue, textFalse) {
        const dotClass = value ? "dot-green" : "dot-red";
        const text = value ? textTrue : textFalse;
        return `<span class="status-dot ${dotClass}"></span> ${text}`;
      }

      function renderUI(status) {
        dom.status.configured.innerHTML = renderStatus(
          status.isConfigured,
          "ƒê√£ c·∫•u h√¨nh",
          "Ch∆∞a c·∫•u h√¨nh",
        );
        dom.status.initialized.innerHTML = renderStatus(
          status.isInitialized,
          "ƒê√£ kh·ªüi t·∫°o",
          "Ch∆∞a kh·ªüi t·∫°o",
        );
        dom.status.autosync.innerHTML = renderStatus(
          status.isAutoSyncActive,
          "ƒêang ho·∫°t ƒë·ªông",
          "ƒê√£ t·∫°m d·ª´ng",
        );
        dom.buttons.manualSync.disabled = !status.isInitialized;

        // Logic n√∫t ch√≠nh
        if (!status.isConfigured) {
          dom.buttons.mainAction.disabled = true;
          dom.buttons.mainAction.textContent = "üöÄ Vui l√≤ng c·∫•u h√¨nh";
        } else {
          dom.buttons.mainAction.disabled = false;
          if (status.isInitialized) {
            dom.buttons.mainAction.textContent = "üîÑ Reset H·ªá th·ªëng";
            dom.buttons.mainAction.className = "btn btn-danger";
          } else {
            dom.buttons.mainAction.textContent = "üöÄ B·∫Øt ƒë·∫ßu Kh·ªüi t·∫°o";
            dom.buttons.mainAction.className = "btn btn-primary";
          }
        }

        // Logic n√∫t Auto Sync
        dom.buttons.toggleAutosync.disabled = !status.isInitialized;
        if (status.isAutoSyncActive) {
          dom.buttons.toggleAutosync.textContent =
            "‚è∏Ô∏è T·∫°m d·ª´ng ƒê·ªìng b·ªô T·ª± ƒë·ªông";
          dom.buttons.toggleAutosync.className = "btn btn-secondary";
        } else {
          dom.buttons.toggleAutosync.textContent =
            "‚ö° K√≠ch ho·∫°t ƒê·ªìng b·ªô T·ª± ƒë·ªông";
          dom.buttons.toggleAutosync.className = "btn btn-success";
        }
      }

      // --- Backend Communication ---
      function handleFailure(err) {
        showToast("L·ªói: " + err.message, true);
        setLoading(false);
      }

      function refreshData() {
        setLoading(true);
        google.script.run
          .withSuccessHandler((status) => {
            renderUI(status);
            google.script.run
              .withSuccessHandler((settings) => {
                Object.keys(dom.inputs).forEach((key) => {
                  if (dom.inputs[key])
                    dom.inputs[key].value = settings[key] || "";
                });
                setLoading(false);
              })
              .withFailureHandler(handleFailure)
              .controllers_Main_getSettings();
          })
          .withFailureHandler(handleFailure)
          .controllers_Main_getSystemStatus();
      }

      // --- Event Listeners ---
      document.addEventListener("DOMContentLoaded", refreshData);

      dom.buttons.mainAction.addEventListener("click", () => {
        const isInitialized =
          dom.buttons.mainAction.textContent.includes("Reset");
        if (isInitialized) {
          const choice = prompt(
            "C·∫¢NH B√ÅO RESET:\nNh·∫≠p '1' ƒë·ªÉ Reset An to√†n (ch·ªâ x√≥a s·ª± ki·ªán c·ªßa h·ªá th·ªëng).\nNh·∫≠p '2' ƒë·ªÉ Reset Nhanh (x√≥a v√† t·∫°o l·∫°i Calendar).\n\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!",
          );
          if (choice === "1" || choice === "2") {
            setLoading(true);
            google.script.run
              .withSuccessHandler((msg) => {
                showToast(msg);
                refreshData();
              })
              .withFailureHandler(handleFailure)
              .controllers_Main_resetSystem(parseInt(choice));
          }
        } else {
          if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën b·∫Øt ƒë·∫ßu kh·ªüi t·∫°o h·ªá th·ªëng?")) {
            setLoading(true);
            google.script.run
              .withSuccessHandler((msg) => {
                showToast(msg);
                refreshData();
              })
              .withFailureHandler(handleFailure)
              .controllers_Main_initializeSystem();
          }
        }
      });

      dom.buttons.toggleAutosync.addEventListener("click", () => {
        const activate =
          !dom.buttons.toggleAutosync.textContent.includes("T·∫°m d·ª´ng");
        setLoading(true);
        google.script.run
          .withSuccessHandler((msg) => {
            showToast(msg);
            refreshData();
          })
          .withFailureHandler(handleFailure)
          .controllers_Main_toggleAutoSync(activate);
      });

      dom.buttons.saveSettings.addEventListener("click", () => {
        const settings = {};
        Object.keys(dom.inputs).forEach((key) => {
          if (dom.inputs[key]) settings[key] = dom.inputs[key].value;
        });
        setLoading(true);
        google.script.run
          .withSuccessHandler((msg) => {
            showToast(msg);
            refreshData();
          })
          .withFailureHandler(handleFailure)
          .controllers_Main_saveSettings(settings);
      });
      dom.buttons.manualSync.addEventListener("click", () => {
        if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën ch·∫°y C·∫≠p nh·∫≠t Nhanh kh√¥ng?")) {
          setLoading(true);
          google.script.run
            .withSuccessHandler((msg) => {
              showToast(msg);
              refreshData();
            })
            .withFailureHandler(handleFailure)
            .controllers_Main_runIntelligentSync();
        }
      });

      document.querySelectorAll(".accordion-header").forEach((header) => {
        header.addEventListener("click", () => {
          const content = header.nextElementSibling;
          header.classList.toggle("active");
          content.classList.toggle("show");
          content.style.maxHeight = content.classList.contains("show")
            ? content.scrollHeight + 20 + "px"
            : null;
        });
      });
    </script>
  </body>
</html>
