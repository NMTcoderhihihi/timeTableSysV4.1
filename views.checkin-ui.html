<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Check-in Bu·ªïi h·ªçc</title>
    <style>
      :root {
        --primary-color: #4285f4;
        --background-color: #f5f5f5;
        --card-background: #ffffff;
        --text-color: #212121;
        --text-light: #757575;
        --success-color: #0f9d58;
        --danger-color: #db4437;
      }
      body {
        margin: 0;
        padding: 20px;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background-color: var(--background-color);
        color: var(--text-color);
        display: flex;
        justify-content: center;
        align-items: flex-start;
        min-height: 100vh;
      }
      .container {
        width: 100%;
        max-width: 400px;
        text-align: center;
      }
      .card {
        background-color: var(--card-background);
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 15px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        opacity: 0;
        transform: translateY(20px);
        animation: fadeIn 0.5s forwards;
      }
      @keyframes fadeIn {
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .title {
        font-size: 20px;
        font-weight: 600;
        margin: 0 0 8px 0;
      }
      .subtitle {
        font-size: 16px;
        color: var(--text-light);
        margin: 0;
      }
      .info-grid {
        display: grid;
        grid-template-columns: auto 1fr;
        gap: 8px;
        text-align: left;
        margin-top: 20px;
        font-size: 16px;
      }
      .label {
        color: var(--text-light);
      }
      .value {
        font-weight: 500;
      }
      #current-status {
        padding: 6px 12px;
        border-radius: 16px;
        font-weight: 500;
        color: white;
        display: inline-block;
      }
      .status-present {
        background-color: var(--success-color);
      }
      .status-absent {
        background-color: var(--danger-color);
      }
      .status-unknown {
        background-color: var(--text-light);
      }
      .button-group {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-top: 20px;
      }
      .btn {
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        color: white;
        transition: background-color 0.2s, opacity 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }
      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .btn-success {
        background-color: var(--success-color);
      }
      .btn-danger {
        background-color: var(--danger-color);
      }
      #message-area {
        margin-top: 15px;
        font-weight: 500;
        min-height: 20px;
      }
      .msg-success {
        color: var(--success-color);
      }
      .msg-error {
        color: var(--danger-color);
      }
      .loader {
        margin: 20px auto;
        border: 4px solid #f3f3f3;
        border-top: 4px solid var(--primary-color);
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div id="loader" class="loader" style="display: none"></div>
      <div id="main-content" class="card" style="display: block">
        <h1 class="title" id="event-title">ƒêang t·∫£i...</h1>
        <p class="subtitle" id="event-time">Vui l√≤ng ch·ªù</p>
        <hr style="border: none; border-top: 1px solid #eee; margin: 20px 0" />
        <div class="info-grid">
          <div class="label">üìç Ph√≤ng:</div>
          <div class="value" id="event-location">...</div>
          <div class="label">üìä Tr·∫°ng th√°i:</div>
          <div class="value"><span id="current-status">...</span></div>
        </div>
        <div class="button-group">
          <button id="btn-present" class="btn btn-success">‚úÖ C√≥ m·∫∑t</button>
          <button id="btn-absent" class="btn btn-danger">‚ö™ V·∫Øng m·∫∑t</button>
        </div>
        <div id="message-area"></div>
      </div>
    </div>

    <script>
      // D√≤ng n√†y r·∫•t quan tr·ªçng: l·∫•y eventHash m√† Code.gs ƒë√£ truy·ªÅn v√†o
      const eventHash = "<?!= eventHash ?>";
      console.log("Checkin Page Loaded. Event Hash from URL:", eventHash); // ++ ADDED

      const dom = {
        loader: document.getElementById("loader"),
        mainContent: document.getElementById("main-content"),
        title: document.getElementById("event-title"),
        time: document.getElementById("event-time"),
        location: document.getElementById("event-location"),
        status: document.getElementById("current-status"),
        message: document.getElementById("message-area"),
        btnPresent: document.getElementById("btn-present"),
        btnAbsent: document.getElementById("btn-absent"),
      };

      function setLoading(isLoading) {
        dom.loader.style.display = isLoading ? "block" : "none";
        dom.mainContent.style.display = isLoading ? "none" : "block";
      }

      function renderEvent(data) {
        if (data.error) {
          dom.title.textContent = "L·ªói";
          dom.time.textContent = data.error;
          dom.location.textContent = "Kh√¥ng c√≥";
          dom.btnPresent.disabled = true;
          dom.btnAbsent.disabled = true;
          return;
        }
        dom.title.textContent = data.tenMonHoc;
        dom.location.textContent = data.tenPhong;

        try {
          const date = new Date(data.thoiGianBD);
          const formattedDate = `${date.getDate()}/${
            date.getMonth() + 1
          }/${date.getFullYear()} l√∫c ${date
            .getHours()
            .toString()
            .padStart(2, "0")}:${date
            .getMinutes()
            .toString()
            .padStart(2, "0")}`;
          dom.time.textContent = formattedDate;
        } catch (e) {
          dom.time.textContent = "Kh√¥ng r√µ th·ªùi gian";
        }

        updateStatusUI(data.daCheckIn);
      }

      function updateStatusUI(status) {
        // ** MODIFIED: C·∫≠p nh·∫≠t tr·ª±c ti·∫øp v√†o dom.status thay v√¨ c√°c thu·ªôc t√≠nh ri√™ng l·∫ª
        const statusSpan = dom.status;
        if (status === true) {
          statusSpan.textContent = "ƒê√£ ƒëi·ªÉm danh C√ì M·∫∂T";
          statusSpan.className = "status-present";
        } else if (status === false) {
          statusSpan.textContent = "ƒê√£ ƒëi·ªÉm danh V·∫ÆNG M·∫∂T";
          statusSpan.className = "status-absent";
        } else {
          statusSpan.textContent = "Ch∆∞a ƒëi·ªÉm danh";
          statusSpan.className = "status-unknown";
        }
      }

      function showMessage(text, isError = false) {
        dom.message.textContent = text;
        dom.message.className = isError ? "msg-error" : "msg-success";
        setTimeout(() => (dom.message.textContent = ""), 3000);
      }

      function setCheckinStatus(status) {
        setLoading(true);
        google.script.run
          .withSuccessHandler((response) => {
            if (response.success) {
              showMessage(response.message);
              updateStatusUI(status); // C·∫≠p nh·∫≠t UI ngay l·∫≠p t·ª©c
            } else {
              showMessage(response.message, true);
            }
            setLoading(false);
          })
          .withFailureHandler((err) => {
            showMessage(err.message, true);
            setLoading(false);
          })
          .controllers_Checkin_setCheckinStatus(eventHash, status);
      }

      // --- Event Listeners ---
      // ** MODIFIED: Hard-code d·ªØ li·ªáu ƒë·ªÉ demo
      document.addEventListener("DOMContentLoaded", () => {
        // D·ªÆ LI·ªÜU GI·∫¢ ƒê·ªÇ DEMO
        const fakeEventData = {
          tenMonHoc: "L·∫≠p tr√¨nh Web N√¢ng cao",
          thoiGianBD: new Date().toISOString(), // L·∫•y th·ªùi gian hi·ªán t·∫°i cho sinh ƒë·ªông
          tenPhong: "Ph√≤ng A.101",
          daCheckIn: null, // Tr·∫°ng th√°i ban ƒë·∫ßu
        };

        // T·∫Øt loader v√† hi·ªÉn th·ªã d·ªØ li·ªáu gi·∫£ ngay l·∫≠p t·ª©c
        setLoading(false);
        renderEvent(fakeEventData);

        // B·∫°n v·∫´n c√≥ th·ªÉ gi·ªØ logic g·ªçi backend ƒë·ªÉ khi demo xong c√≥ th·ªÉ b·∫≠t l·∫°i
        // google.script.run... (ƒë√£ b·ªã v√¥ hi·ªáu h√≥a)
      });

      dom.btnPresent.addEventListener("click", () => setCheckinStatus(true));
      dom.btnAbsent.addEventListener("click", () => setCheckinStatus(false));
    </script>
  </body>
</html>
